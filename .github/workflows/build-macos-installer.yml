name: Build macOS Installer

on:
  workflow_dispatch:  
  push:
    branches:
      - main
    paths:
      - 'macos/**'                                   
      - 'lib/**'                                     
      - 'pubspec.yaml'                               
      - 'pubspec.lock'                               
      - 'assets/**'                                  
      - '.github/workflows/build-macos-installer.yml'
      - 'flutter_launcher_icons.yaml'      

  pull_request:
    branches:
      - main
    paths:
      - 'macos/**'
      - 'lib/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'assets/**'
      - '.github/workflows/build-macos-installer.yml'
      - 'flutter_launcher_icons.yaml'      

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    runs-on: macos-latest
    environment: release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          echo "üìù Importing code signing certificate..."
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          rm certificate.p12
          echo "‚úÖ Certificate imported successfully"

      - name: Build macOS release
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
          LOCAL_DB_KEY: ${{ secrets.LOCAL_DB_KEY }}
        run: |
          echo "üîç Debugging Secrets..."
          if [ -z "$PROJECT_URL" ]; then echo "‚ùå PROJECT_URL is empty"; else echo "‚úÖ PROJECT_URL is set (length: ${#PROJECT_URL})"; fi
          if [ -z "$PROJECT_KEY" ]; then echo "‚ùå PROJECT_KEY is empty"; else echo "‚úÖ PROJECT_KEY is set (length: ${#PROJECT_KEY})"; fi
          if [ -z "$LOCAL_DB_KEY" ]; then echo "‚ùå LOCAL_DB_KEY is empty"; else echo "‚úÖ LOCAL_DB_KEY is set (length: ${#LOCAL_DB_KEY})"; fi
          
          flutter build macos --release \
            --dart-define=PROJECT_URL="$PROJECT_URL" \
            --dart-define=PROJECT_KEY="$PROJECT_KEY" \
            --dart-define=LOCAL_DB_KEY="$LOCAL_DB_KEY" \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Sign macOS App
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ÔøΩ Listing available signing identities..."
          security find-identity -v -p codesigning
          
          echo "ÔøΩüîê Signing macOS app..."
          codesign --deep --force --verify --verbose \
            --sign "Developer ID Application" \
            --options runtime \
            --timestamp \
            "build/macos/Build/Products/Release/contrack.app"
          
          echo "‚úÖ Verifying signature..."
          codesign --verify --verbose=4 "build/macos/Build/Products/Release/contrack.app"
          echo "‚úÖ App signed successfully"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG installer
        run: |
          create-dmg \
            --volname "Contrack Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "contrack.app" 200 190 \
            --hide-extension "contrack.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "build/macos/contrack.dmg" \
            "build/macos/Build/Products/Release/contrack.app" || true

      - name: Sign DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "üîê Signing DMG..."
          codesign --sign "Developer ID Application" \
            --timestamp \
            "build/macos/contrack.dmg"
          echo "‚úÖ DMG signed successfully"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "üì§ Submitting DMG for notarization..."
          xcrun notarytool submit "build/macos/contrack.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait
          
          echo "üìé Stapling notarization ticket to DMG..."
          xcrun stapler staple "build/macos/contrack.dmg"
          
          echo "‚úÖ Verifying notarization..."
          xcrun stapler validate "build/macos/contrack.dmg"
          echo "‚úÖ DMG notarized successfully"

      - name: Verify DMG creation
        run: |
          if [ -f "build/macos/contrack.dmg" ]; then
            echo "DMG created successfully"
            ls -lh build/macos/contrack.dmg
          else
            echo "DMG creation failed, checking for alternative location"
            find build/macos -name "*.dmg" -type f
          fi

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: build/macos/contrack.dmg
          retention-days: 30

      - name: Create Release (on main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ github.run_number }}
          name: Release v1.0.0-${{ github.run_number }}
          files: build/macos/contrack.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
