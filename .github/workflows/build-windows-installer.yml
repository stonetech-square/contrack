name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'windows/**'
      - 'lib/**'                                    
      - 'pubspec.yaml'                              
      - 'pubspec.lock'                              
      - 'assets/**'                                 
      - '.github/workflows/build-windows-installer.yml'
      - 'windows/installer.iss'
      - 'flutter_launcher_icons.yaml'
      - 'assets/*'
  pull_request:
    branches:
      - main
    paths:
      - 'windows/**'
      - 'lib/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'assets/**'
      - '.github/workflows/build-windows-installer.yml'
      - 'windows/installer.iss'
      - 'flutter_launcher_icons.yaml'
      - 'assets/*'

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    environment: release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows release
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
          LOCAL_DB_KEY: ${{ secrets.LOCAL_DB_KEY }}
        run: |
          echo "üîç Debugging Secrets..."
          if ($env:PROJECT_URL -eq "") { echo "‚ùå PROJECT_URL is empty" } else { echo "‚úÖ PROJECT_URL is set (length: $($env:PROJECT_URL.Length))" }
          if ($env:PROJECT_KEY -eq "") { echo "‚ùå PROJECT_KEY is empty" } else { echo "‚úÖ PROJECT_KEY is set (length: $($env:PROJECT_KEY.Length))" }
          if ($env:LOCAL_DB_KEY -eq "") { echo "‚ùå LOCAL_DB_KEY is empty" } else { echo "‚úÖ LOCAL_DB_KEY is set (length: $($env:LOCAL_DB_KEY.Length))" }

          flutter build windows --release `
            --dart-define=PROJECT_URL="$env:PROJECT_URL" `
            --dart-define=PROJECT_KEY="$env:PROJECT_KEY" `
            --dart-define=LOCAL_DB_KEY="$env:LOCAL_DB_KEY"

      - name: Create Inno Setup script
        run: |
          $issContent = @"
          #define MyAppName "Contrack"
          #define MyAppVersion "1.0.0"
          #define MyAppPublisher "StoneTech"
          #define MyAppExeName "contrack.exe"

          [Setup]
          AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=..\build\windows\installer
          OutputBaseFilename=contrack-setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=admin

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

          [Files]
          Source: "..\build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
          "@
          New-Item -ItemType Directory -Force -Path "windows"
          Set-Content -Path "windows\installer.iss" -Value $issContent

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Create installer directory
        run: |
          New-Item -ItemType Directory -Force -Path "build\windows\installer"

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer.iss"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/windows/installer/contrack-setup.exe
          retention-days: 30

      - name: Create Release (on main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ github.run_number }}
          name: Release v1.0.0-${{ github.run_number }}
          files: build/windows/installer/contrack-setup.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
