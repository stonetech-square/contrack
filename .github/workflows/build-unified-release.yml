name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'assets/**'
      - 'macos/**'
      - 'windows/**'
      - '.github/workflows/build-unified-release.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'assets/**'
      - 'macos/**'
      - 'windows/**'
      - '.github/workflows/build-unified-release.yml'

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    environment: release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache Pub Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: macos/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('macos/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Get dependencies
        run: flutter pub get

      - name: Import Code Signing Certificate
        continue-on-error: true
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERTIFICATE" ]; then
            echo "üìù Importing code signing certificate..."
            echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
            security create-keychain -p actions build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p actions build.keychain
            security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
            rm certificate.p12
            echo "‚úÖ Certificate imported successfully"
          else
            echo "‚ö†Ô∏è MACOS_CERTIFICATE secret is not set. Skipping certificate import."
          fi

      - name: Build macOS release
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
          LOCAL_DB_KEY: ${{ secrets.LOCAL_DB_KEY }}
        run: |
          flutter build macos --release \
            --dart-define=PROJECT_URL="$PROJECT_URL" \
            --dart-define=PROJECT_KEY="$PROJECT_KEY" \
            --dart-define=LOCAL_DB_KEY="$LOCAL_DB_KEY" \
            --build-name=1.0.0 \
            --build-number=${{ github.run_number }}

      - name: Sign macOS App
        continue-on-error: true
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "üîê Checking for signing identity..."
          if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
            echo "‚úÖ Identity found. Signing macOS app..."
            codesign --deep --force --verify --verbose \
              --sign "Developer ID Application" \
              --options runtime \
              --timestamp \
              "build/macos/Build/Products/Release/contrack.app"
            
            echo "‚úÖ Verifying signature..."
            codesign --verify --verbose=4 "build/macos/Build/Products/Release/contrack.app"
            echo "‚úÖ App signed successfully"
          else
            echo "‚ö†Ô∏è No signing identity found. Skipping App signing."
          fi

      - name: Install create-dmg
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: brew install create-dmg

      - name: Create DMG installer
        run: |
          rm -f "build/macos/contrack.dmg"

          create-dmg \
            --volname "Contrack Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "contrack.app" 200 190 \
            --hide-extension "contrack.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "build/macos/contrack.dmg" \
            "build/macos/Build/Products/Release/contrack.app" || {
              echo "create-dmg exited with error, checking if DMG exists..."
              if [ -f "build/macos/contrack.dmg" ]; then
                echo "DMG exists despite exit code."
              else
                echo "‚ùå DMG creation failed."
                exit 1
              fi
            }

      - name: Sign DMG
        continue-on-error: true
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "üîê Checking for signing identity..."
          if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
            echo "‚úÖ Identity found. Signing DMG..."
            codesign --sign "Developer ID Application" \
              --timestamp \
              "build/macos/contrack.dmg"
            echo "‚úÖ DMG signed successfully"
          else
             echo "‚ö†Ô∏è No signing identity found. Skipping DMG signing."
          fi

      - name: Notarize DMG
        continue-on-error: true
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_ID_PASSWORD" ] && [ -n "$APPLE_TEAM_ID" ]; then
             echo "üì§ Submitting DMG for notarization..."
             if security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
                xcrun notarytool submit "build/macos/contrack.dmg" \
                  --apple-id "$APPLE_ID" \
                  --team-id "$APPLE_TEAM_ID" \
                  --password "$APPLE_ID_PASSWORD" \
                  --wait
                
                echo "üìé Stapling notarization ticket to DMG..."
                xcrun stapler staple "build/macos/contrack.dmg"
                
                echo "‚úÖ Verifying notarization..."
                xcrun stapler validate "build/macos/contrack.dmg"
                echo "‚úÖ DMG notarized successfully"
             else
                echo "‚ö†Ô∏è App/DMG likely not signed. Skipping notarization."
             fi
          else
             echo "‚ö†Ô∏è Notarization secrets missing. Skipping."
          fi

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: build/macos/contrack.dmg
          retention-days: 1

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    environment: release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows release
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
          LOCAL_DB_KEY: ${{ secrets.LOCAL_DB_KEY }}
        run: |
          flutter build windows --release `
            --dart-define=PROJECT_URL="$env:PROJECT_URL" `
            --dart-define=PROJECT_KEY="$env:PROJECT_KEY" `
            --dart-define=LOCAL_DB_KEY="$env:LOCAL_DB_KEY"

      - name: Create Inno Setup script
        run: |
          $issContent = @"
          #define MyAppName "Contrack"
          #define MyAppVersion "1.0.0"
          #define MyAppPublisher "StoneTech"
          #define MyAppExeName "contrack.exe"

          [Setup]
          AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=..\build\windows\installer
          OutputBaseFilename=contrack-setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=admin

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

          [Files]
          Source: "..\build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
          "@
          New-Item -ItemType Directory -Force -Path "windows"
          Set-Content -Path "windows\installer.iss" -Value $issContent

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Create installer directory
        run: New-Item -ItemType Directory -Force -Path "build\windows\installer"

      - name: Build installer
        run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer.iss"'

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/windows/installer/contrack-setup.exe
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    environment: release
    needs: [build-macos, build-windows]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: .

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: .

      - name: Upload to Supabase Storage
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
          PROJECT_SECRET: ${{ secrets.PROJECT_SECRET }}
        continue-on-error: true
        run: |
          if [ -n "$PROJECT_SECRET" ] && [ -n "$PROJECT_URL" ]; then
             echo "üöÄ Uploading installers to Supabase Storage..."
             
             # Upload DMG
             if [ -f "contrack.dmg" ]; then
               echo "üì§ Uploading contrack.dmg..."
               curl -X POST "${PROJECT_URL}/storage/v1/object/installations/contrack.dmg" \
                 -H "Authorization: Bearer ${PROJECT_SECRET}" \
                 -H "Content-Type: application/x-apple-diskimage" \
                 -H "x-upsert: true" \
                 --data-binary "@contrack.dmg" || echo "‚ö†Ô∏è Failed to upload DMG"
             else
               echo "‚ö†Ô∏è contrack.dmg not found, skipping upload."
             fi

             # Upload EXE
             if [ -f "contrack-setup.exe" ]; then
               echo "üì§ Uploading contrack-setup.exe as contrack.exe..."
               curl -X POST "${PROJECT_URL}/storage/v1/object/installations/contrack.exe" \
                 -H "Authorization: Bearer ${PROJECT_SECRET}" \
                 -H "Content-Type: application/vnd.microsoft.portable-executable" \
                 -H "x-upsert: true" \
                 --data-binary "@contrack-setup.exe" || echo "‚ö†Ô∏è Failed to upload EXE"
             else
               echo "‚ö†Ô∏è contrack-setup.exe not found, skipping upload."
             fi
             
             echo "‚úÖ Storage upload process completed."
          else
             echo "‚ö†Ô∏è PROJECT_SECRET or PROJECT_URL missing. Skipping upload to Supabase Storage."
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ github.run_number }}
          name: Release v1.0.0-${{ github.run_number }}
          files: |
            contrack.dmg
            contrack-setup.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
